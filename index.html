<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Poker Panel PRO</title>
<style>
:root{
  --green:#10b981; --red:#ef4444; --blue:#3b82f6; --blue-dark:#1e3a8a;
  --bg:linear-gradient(to right, #3b82f6, #60a5fa, #93c5fd);
}
*{box-sizing:border-box}
body{
  margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  background:var(--bg); min-height:100vh; display:flex; align-items:center; justify-content:center;
}
main{
  width:min(1200px,95vw); background:#fff; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.25);
  overflow:hidden;
}
header{background:var(--blue-dark); color:#fff; padding:16px 20px; text-align:center}
nav{display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-top:10px}
.tab{background:var(--blue); color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer}
.tab.active{background:#1d4ed8}
section{display:none; padding:20px}
section.active{display:block}
h2 { margin:0 0 4px; text-align:center; }
.quote { margin:6px 0 14px; font-style:italic; color:#1e3a8a; text-align:center; }
.form{max-width:560px; margin:0 auto}
label{display:block; margin-top:10px; font-size:14px; text-align:left}
input,select,textarea{width:100%; padding:8px; border:1px solid #cbd5e1; border-radius:8px; background:#f8fafc}
.row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
.inline{display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; margin-top:10px}
.btn{padding:8px 12px; border:none; border-radius:8px; cursor:pointer}
.btn-primary{background:var(--green); color:#fff}
.btn-neutral{background:#e5e7eb}
.btn-danger{background:var(--red); color:#fff}
table{width:100%; border-collapse:collapse; margin-top:14px}
th,td{border:1px solid #e5e7eb; padding:8px; font-size:13px; text-align:center}
th{background:#dbeafe}
tr.ganado{background:#d1fae5}
tr.perdido{background:#fee2e2}
canvas{background:#f8fafc; border-radius:12px; padding:8px; display:block; margin:14px auto}
.note{font-size:12px; color:#475569}
</style>
</head>
<body>
<main>
  <header>
    <h1 style="margin:0">Poker Panel PRO</h1>
    <nav>
      <button class="tab active" data-tab="badbits">BadBits</button>
      <button class="tab" data-tab="flips">Flips</button>
      <button class="tab" data-tab="torneos">Torneos</button>
      <button class="tab" data-tab="historial">Semanal</button>
      <button class="tab" data-tab="resumen">Resumen</button>
      <button class="tab" data-tab="config">Config</button>
    </nav>
  </header>

  <!-- BADBITS -->
  <section id="badbits" class="active">
    <h2>Registrar BadBit</h2>
    <div class="quote">‚ÄúLo que no controlas no te pertenece ‚Äî Epicteto‚Äù</div>
    <form id="bb_form" class="form">
      <label>Fecha <input type="date" name="fecha"></label>
      <label>Sala
        <select name="sala">
          <option>Black Poker</option><option>PokerStars</option><option>GG Poker</option>
          <option>CoinPoker</option><option>BetOnline</option><option>PartyPoker</option>
        </select>
      </label>
      <div class="row">
        <label>Mi Mano <input type="text" name="mi_mano" placeholder="AhKh o AKs/AKo"></label>
        <label>Mano Rival <input type="text" name="mano_rival" placeholder="QdQs o QQ"></label>
      </div>
      <div class="inline">
        <span class="chip">Equity:</span>
        <input type="number" step="0.01" name="equity" id="bb_equity" placeholder="Auto" readonly>
        <button type="button" id="bb_calc" class="btn btn-neutral">Calcular</button>
      </div>
      <label>Resultado
        <select name="resultado"><option>Ganado</option><option>Perdido</option><option>En juego</option></select>
      </label>
      <label>Notas <textarea rows="2" name="notas"></textarea></label>
      <div class="inline">
        <button class="btn btn-primary" type="submit">Guardar</button>
      </div>
    </form>
    <table id="bb_table">
      <thead>
        <tr><th>Fecha</th><th>Sala</th><th>Mi Mano</th><th>Rival</th><th>Equity</th><th>Resultado</th><th>Notas</th><th>‚úèÔ∏è</th><th>üóëÔ∏è</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <canvas id="bb_chart" width="420" height="220"></canvas>
  </section>

  <!-- FLIPS -->
  <section id="flips">
    <h2>Registrar Flip</h2>
    <div class="quote">‚ÄúEl destino baraja las cartas, nosotros jugamos la mano ‚Äî S√©neca‚Äù</div>
    <form id="fp_form" class="form">
      <label>Fecha <input type="date" name="fecha"></label>
      <label>Sala
        <select name="sala">
          <option>Black Poker</option><option>PokerStars</option><option>GG Poker</option>
          <option>CoinPoker</option><option>BetOnline</option><option>PartyPoker</option>
        </select>
      </label>
      <div class="row">
        <label>Mi Mano <input type="text" name="mi_mano"></label>
        <label>Mano Rival <input type="text" name="mano_rival"></label>
      </div>
      <div class="inline">
        <span class="chip">Equity:</span>
        <input type="number" step="0.01" name="equity" id="fp_equity" placeholder="Auto" readonly>
        <button type="button" id="fp_calc" class="btn btn-neutral">Calcular</button>
      </div>
      <label>Resultado
        <select name="resultado"><option>Ganado</option><option>Perdido</option><option>En juego</option></select>
      </label>
      <label>Notas <textarea rows="2" name="notas"></textarea></label>
      <div class="inline">
        <button class="btn btn-primary" type="submit">Guardar</button>
      </div>
    </form>
    <table id="fp_table">
      <thead>
        <tr><th>Fecha</th><th>Sala</th><th>Mi Mano</th><th>Rival</th><th>Equity</th><th>Resultado</th><th>Notas</th><th>‚úèÔ∏è</th><th>üóëÔ∏è</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <canvas id="fp_chart" width="420" height="220"></canvas>
  </section>

  <!-- TORNEOS -->
  <section id="torneos">
    <h2>Registrar Torneo</h2>
    <div class="quote">‚ÄúLa disciplina vence a la suerte ‚Äî Marco Aurelio‚Äù</div>
    <form id="tr_form" class="form">
      <label>Fecha <input type="date" name="fecha"></label>
      <label>Sala
        <select name="sala">
          <option>Black Poker</option><option>PokerStars</option><option>GG Poker</option>
          <option>CoinPoker</option><option>BetOnline</option><option>PartyPoker</option>
        </select>
      </label>
      <label>Nombre del Torneo <input type="text" name="nombre"></label>
      <div class="row">
        <label>Buy-in <input type="number" step="0.01" name="buyin"></label>
        <label>Fee <input type="number" step="0.01" name="fee"></label>
      </div>
      <label>Premio (Ganancia) <input type="number" step="0.01" name="premio"></label>
      <div class="row">
        <label>Entradas <input type="number" name="entradas"></label>
        <label>Posici√≥n <input type="number" name="pos"></label>
      </div>
      <label>N√∫mero de manos <input type="number" name="manos" placeholder="ej. 200"></label>
      <label>Resultado
        <select name="resultado"><option>Ganado</option><option>Perdido</option><option>En juego</option></select>
      </label>
      <label>Notas <textarea rows="2" name="notas"></textarea></label>
      <div class="inline">
        <button class="btn btn-primary" type="submit">Guardar</button>
      </div>
    </form>
    <table id="tr_table">
      <thead>
        <tr><th>Fecha</th><th>Sala</th><th>Nombre</th><th>Buy-in</th><th>Fee</th><th>Premio</th><th>Entradas</th><th>Pos</th><th>Inv</th><th>Neto</th><th>ROI</th><th>Resultado</th><th>Notas</th><th>‚úèÔ∏è</th><th>üóëÔ∏è</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <canvas id="tr_chart" width="420" height="220"></canvas>
  </section>

  <!-- SEMANAL -->
  <section id="historial">
    <h2>Semanal</h2>
    <div class="quote">‚ÄúEl tiempo revela todas las cosas ‚Äî S√©neca‚Äù</div>
    <table id="wk_table">
      <thead><tr>
        <th>Semana</th><th>Inv</th><th>Premios</th><th>Neto</th><th>ROI</th><th>Manos</th>
      </tr></thead>
      <tbody></tbody>
    </table>
    <canvas id="wk_chart" width="420" height="220"></canvas>
    <canvas id="roi_chart" width="420" height="220"></canvas>
    <canvas id="manos_chart" width="420" height="220"></canvas>
  </section>

  <!-- RESUMEN -->
  <section id="resumen">
    <h2>Resumen</h2>
    <div class="quote">‚ÄúConstancia es el verdadero camino a la victoria ‚Äî Epicteto‚Äù</div>
    <div id="summary"></div>
    <canvas id="summary_chart" width="420" height="220"></canvas>
    <canvas id="dist_chart" width="420" height="220"></canvas>
  
    <h3>Papelera de BadBits</h3>
    <table id="trash_bb"><thead><tr><th>Fecha</th><th>Sala</th><th>Acci√≥n</th></tr></thead><tbody></tbody></table>
    <h3>Papelera de Flips</h3>
    <table id="trash_fp"><thead><tr><th>Fecha</th><th>Sala</th><th>Acci√≥n</th></tr></thead><tbody></tbody></table>
    <h3>Papelera de Torneos</h3>
    <table id="trash_tr"><thead><tr><th>Fecha</th><th>Sala</th><th>Nombre</th><th>Acci√≥n</th></tr></thead><tbody></tbody></table>
    </section>

  <!-- CONFIG -->
  <section id="config">
    <h2>Config</h2>
    <div class="quote">‚ÄúPrimero dom√≠nate a ti mismo ‚Äî Epicteto‚Äù</div>
    <p>Env√≠o a Google Sheets activado (modo no-cors). Endpoint configurado.</p>
    <h3>Papelera de Torneos Eliminados</h3>
    <table id="trash_table"><thead><tr><th>Fecha</th><th>Sala</th><th>Nombre</th><th>Acci√≥n</th></tr></thead><tbody></tbody></table>
    <h2>Config</h2>
    <div class="quote">‚ÄúPrimero dom√≠nate a ti mismo ‚Äî Epicteto‚Äù</div>
    <p>Env√≠o a Google Sheets activado (modo no-cors). Endpoint configurado.</p>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js">
// ====== Torneos: Render personalizado con Edit & Delete (con confirm) ======
function renderTableTorneos(){
  const data = loadData('torneos');
  const tbody = document.querySelector('#tr_table tbody');
  if(!tbody) return;
  tbody.innerHTML = '';
  data.forEach((row,i)=>{
    const tr = document.createElement('tr');
    const inv=(+row.buyin||0)+(+row.fee||0);
    const neto=(+row.premio||0)-inv;
    const roi = inv>0 ? ((neto/inv)*100).toFixed(1)+'%' : '0%';
    tr.innerHTML = '<td>'+(row.fecha||'')+'</td><td>'+(row.sala||'')+'</td><td>'+(row.nombre||'')+'</td>'
      + '<td>'+(row.buyin||'')+'</td><td>'+(row.fee||'')+'</td><td>'+(row.premio||'')+'</td><td>'+(row.entradas||'')+'</td><td>'+(row.pos||'')+'</td>'
      + '<td>'+inv.toFixed(2)+'</td><td>'+neto.toFixed(2)+'</td><td>'+roi+'</td>'
      + '<td>'+(row.resultado||'')+'</td><td>'+(row.notas||'')+'</td>';
    if(neto>=0) tr.classList.add('ganado'); else tr.classList.add('perdido');

    // Edit button
    const tdE = document.createElement('td');
    const bE = document.createElement('button');
    bE.textContent = '‚úèÔ∏è'; bE.className = 'btn btn-neutral';
    bE.onclick = function(){
      const f = document.getElementById('tr_form');
      if(!f) return;
      for(const [k,v] of Object.entries(row)){ if(f[k]!==undefined) f[k].value = v; }
      f.dataset.editIndex = i; // mark editing index
      // Cambia de pesta√±a a "torneos" si est√°s en otra
      document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
      document.querySelector('.tab[data-tab="torneos"]').classList.add('active');
      document.getElementById('torneos').classList.add('active');
      window.scrollTo({top:0, behavior:'smooth'});
    };
    tdE.appendChild(bE);
    tr.appendChild(tdE);

    // Delete button with confirm + move to trash
    const tdD = document.createElement('td');
    const bD = document.createElement('button');
    bD.textContent = 'üóëÔ∏è'; bD.className = 'btn btn-danger';
    bD.onclick = function(){
      if(!confirm('¬øSeguro que quieres borrar este torneo?')) return;
      const arr = loadData('torneos');
      const removed = arr.splice(i,1)[0];
      saveData('torneos', arr);
      const trash = loadData('torneos_eliminados'); trash.push(removed); saveData('torneos_eliminados', trash);
      updateAll();
    };
    tdD.appendChild(bD);
    tr.appendChild(tdD);

    tbody.appendChild(tr);
  });
}

// Hook: override only the torneos render call, keep the rest intact
(function(){
  // Monkey-patch updateAll to replace generic torneos render by our custom one
  const _ua = updateAll;
  window.updateAll = function(){
    // call original
    _ua();
    try {
      // Immediately after original renders, overwrite torneos table with custom actions
      if(document.getElementById('tr_table')) renderTableTorneos();
      renderTrash();
    } catch(e){ console.warn('patch updateAll error', e); }
  };
})();

// ====== Papelera (Trash) in Config ======
function renderTrash(){
  const arr = loadData('torneos_eliminados');
  const tbody = document.querySelector('#trash_table tbody');
  if(!tbody) return;
  tbody.innerHTML = '';
  arr.forEach((row,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = '<td>'+(row.fecha||'')+'</td><td>'+(row.sala||'')+'</td><td>'+(row.nombre||'')+'</td>';
    const td = document.createElement('td');
    const btn = document.createElement('button');
    btn.textContent = '‚ôªÔ∏è Restaurar'; btn.className = 'btn btn-primary';
    btn.onclick = function(){
      const trash = loadData('torneos_eliminados');
      const rec = trash.splice(i,1)[0];
      saveData('torneos_eliminados', trash);
      const arr = loadData('torneos'); arr.push(rec); saveData('torneos', arr);
      updateAll();
    };
    td.appendChild(btn);
    tr.appendChild(td);
    tbody.appendChild(tr);
  });
}

// ====== Submit en Torneos con modo edici√≥n ======
(function(){
  const form = document.getElementById('tr_form');
  if(!form) return;
  const originalSubmit = form.onsubmit;
  form.onsubmit = function(e){
    e.preventDefault();
    const row = Object.fromEntries(new FormData(form).entries());
    let arr = loadData('torneos');
    if(form.dataset.editIndex !== undefined){
      const idx = +form.dataset.editIndex;
      arr[idx] = row;
      delete form.dataset.editIndex;
    } else {
      arr.push(row);
    }
    saveData('torneos', arr);
    sendToSheets(Object.assign({tipo:'Torneo'}, row));
    form.reset();
    updateAll();
  };
})();

// Render trash on load once
document.addEventListener('DOMContentLoaded', renderTrash);

</script>
<script>
// ========= Tabs =========
const tabs = document.querySelectorAll('.tab');
const sections = document.querySelectorAll('section');
tabs.forEach(btn => btn.addEventListener('click', () => {
  tabs.forEach(b=>b.classList.remove('active'));
  sections.forEach(s=>s.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById(btn.dataset.tab).classList.add('active');
  updateAll();
}));

// ========= Storage =========
function saveData(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
function loadData(key) { return JSON.parse(localStorage.getItem(key) || '[]'); }

// ========= CSV (opcional) =========
function toCSV(rows, headers) { let csv = headers.join(',') + '\n'; rows.forEach(r=> csv += headers.map(h => (r[h]??'')).join(',') + '\n'); return csv; }

// ========= Sheets Endpoint =========
const ENDPOINT = "https://script.google.com/macros/s/AKfycbw4I3p6FQCH8qFsypEcADkpY452ARBiFFPAI_drFFX1iK28fGO5MiulhsCXDoasNsNU/exec";
function sendToSheets(payload) {
  try { fetch(ENDPOINT, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) }); }
  catch(e) { console.warn('Sheets error', e); }
}

// ========= Equity (Monte Carlo) =========
const RANKS = "23456789TJQKA"; const SUITS="cdhs";
function expandHand(str) {
  if(!str) return null; str=str.replace(/\s+/g,'').toUpperCase();
  if(str.length===4 && SUITS.includes(str[1].toLowerCase()) && SUITS.includes(str[3].toLowerCase())) return [str[0]+str[1].toLowerCase(), str[2]+str[3].toLowerCase()];
  if(str.length===2 && str[0]===str[1]) return str;
  if(/^[2-9TJQKA]{2}[SO]?$/.test(str)) return str;
  return null;
}
function randomComboFromAbstract(desc, used) {
  used = used || {};
  function rand(a){return a[Math.floor(Math.random()*a.length)];}
  const r1=desc[0], r2=desc[1];
  if(r1===r2 && desc.length===2){ const rank=r1; const cards=Array.from(SUITS).map(s=>rank+s).filter(c=>!used[c]);
    if(cards.length<2) return null; const c1=rand(cards); used[c1]=true; const rest=cards.filter(c=>c!==c1); const c2=rand(rest); return [c1,c2]; }
  const suited = desc.endsWith('S'); const offsuit = desc.endsWith('O'); const ranks=[desc[0],desc[1]];
  let candidates=[];
  for(const s1 of SUITS) for(const s2 of SUITS) {
    if(s1===s2 && offsuit) continue; if(s1!==s2 && suited) continue;
    const c1=ranks[0]+s1, c2=ranks[1]+s2; if(c1===c2) continue; if(used[c1]||used[c2]) continue; candidates.push([c1,c2]);
  }
  if(!candidates.length) return null; return rand(candidates);
}
function parseInputToCombo(str, used){ const e=expandHand(str); if(!e) return null; if(Array.isArray(e)) return e; return randomComboFromAbstract(e, used||{}); }
function handRank5(cards){
  const ranks = cards.map(c=>RANKS.indexOf(c[0])).sort((a,b)=>b-a);
  const suits = cards.map(c=>c[1]);
  const counts={}, suitCounts={}, uniq=[];
  ranks.forEach(r=>counts[r]=(counts[r]||0)+1); suits.forEach(s=>suitCounts[s]=(suitCounts[s]||0)+1);
  for(const r of ranks) if(!uniq.includes(r)) uniq.push(r);
  const isFlush = Object.values(suitCounts).some(v=>v===5);
  let isStraight=false, top=uniq[0]; let seq=[uniq[0]];
  for(let i=1;i<uniq.length;i++){ if(uniq[i]===uniq[i-1]-1) seq.push(uniq[i]); else break; }
  if(seq.length>=5){isStraight=true; top=seq[0];}
  if(!isStraight && uniq.includes(12)&&uniq.includes(3)&&uniq.includes(2)&&uniq.includes(1)&&uniq.includes(0)){isStraight=true; top=3;}
  const groups = Object.entries(counts).map(([r,c])=>[+r,c]).sort((a,b)=> b[1]-a[1] || b[0]-a[0]);
  if(isFlush && isStraight) return [8, top];
  if(groups[0][1]===4) return [7, groups[0][0], groups[1][0]];
  if(groups[0][1]===3 && groups[1]&&groups[1][1]===2) return [6, groups[0][0], groups[1][0]];
  if(isFlush) return [5, ...ranks];
  if(isStraight) return [4, top];
  if(groups[0][1]===3) return [3, groups[0][0], ...groups.filter(g=>g[1]===1).map(g=>g[0])];
  if(groups[0][1]===2 && groups[1]&&groups[1][1]===2) return [2, groups[0][0], groups[1][0], ...groups.filter(g=>g[1]===1).map(g=>g[0])];
  if(groups[0][1]===2) return [1, groups[0][0], ...groups.filter(g=>g[1]===1).map(g=>g[0])];
  return [0, ...ranks];
}
function compareRank(a,b){ for(let i=0;i<Math.max(a.length,b.length);i++){const x=a[i]??-1, y=b[i]??-1; if(x!==y) return x>y?1:-1;} return 0; }
function best5of7(seven){ let best=null;
  for(let a=0;a<7;a++) for(let b=a+1;b<7;b++) for(let c=b+1;c<7;c++) for(let d=c+1;d<7;d++) for(let e=d+1;e<7;e++) {
    const r=handRank5([seven[a],seven[b],seven[c],seven[d],seven[e]]); if(!best || compareRank(r,best)>0) best=r;
  } return best; }
function deckExcluding(ex){ const set=new Set(ex); const d=[]; for(const r of RANKS) for(const s of SUITS){ const c=r+s; if(!set.has(c)) d.push(c); } return d; }
function monteCarloEquity(h1,h2,trials=5000){ const used=new Set([...h1,...h2]); let w1=0,w2=0,t=0;
  for(let k=0;k<trials;k++){ const deck=deckExcluding(used);
    for(let i=deck.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [deck[i],deck[j]]=[deck[j],deck[i]];}
    const board=deck.slice(0,5);
    const b1=best5of7([h1[0],h1[1],...board]); const b2=best5of7([h2[0],h2[1],...board]);
    const cmp=compareRank(b1,b2); if(cmp>0) w1++; else if(cmp<0) w2++; else t++;
  } const N=w1+w2+t; return {p1:(w1+t/2)/N, p2:(w2+t/2)/N}; }
function calcEquity(outId, mi, rival){
  const used={}; const h1=parseInputToCombo(mi,used); if(!h1) return alert('Mi Mano inv√°lida');
  const h2=parseInputToCombo(rival,used); if(!h2) return alert('Mano Rival inv√°lida');
  const res = monteCarloEquity(h1,h2,7000);
  const el = document.getElementById(outId); if(el) el.value=(res.p1*100).toFixed(2);
}

// ========= Helpers time/week =========
function parseDate(s){ return s ? new Date(s+'T00:00:00') : null; }
function getISOWeek(d){ d=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate())); var day=d.getUTCDay()||7; d.setUTCDate(d.getUTCDate()+4-day); var yearStart=new Date(Date.UTC(d.getUTCFullYear(),0,1)); return Math.ceil((((d-yearStart)/86400000)+1)/7); }
function getISOWeekYear(d){ d=new Date(d.getTime()); d.setDate(d.getDate()+4-(d.getDay()||7)); return d.getFullYear(); }
function weekKey(date){ return getISOWeekYear(date)+'-W'+String(getISOWeek(date)).padStart(2,'0'); }

// ========= Render tables & charts =========
let bbChart, fpChart, trChart, wkChart, roiChart, manosChart, summaryChart, distChart;

function renderTable(key, tableId){
  const data = loadData(key);
  const tbody = document.querySelector(tableId+' tbody');
  tbody.innerHTML = '';
  data.forEach((row,i)=>{
    const tr = document.createElement('tr');
    if(key==='torneos'){
      const inv=(+row.buyin||0)+(+row.fee||0);
      const neto=(+row.premio||0)-inv;
      const roi = inv>0 ? ((neto/inv)*100).toFixed(1)+'%' : '0%';
      tr.innerHTML = '<td>'+ (row.fecha||'') +'</td><td>'+ (row.sala||'') +'</td><td>'+ (row.nombre||'') +'</td>'
        + '<td>'+ (row.buyin||'') +'</td><td>'+ (row.fee||'') +'</td><td>'+ (row.premio||'') +'</td><td>'+ (row.entradas||'') +'</td><td>'+ (row.pos||'') +'</td>'
        + '<td>'+ inv.toFixed(2) +'</td><td>'+ neto.toFixed(2) +'</td><td>'+ roi +'</td>'
        + '<td>'+ (row.resultado||'') +'</td><td>'+ (row.notas||'') +'</td>';
      if(neto>=0) tr.classList.add('ganado'); else tr.classList.add('perdido');
    } else {
      tr.innerHTML = '<td>'+ (row.fecha||'') +'</td><td>'+ (row.sala||'') +'</td><td>'+ (row.mi_mano||'') +'</td><td>'+ (row.mano_rival||'') +'</td>'
        + '<td>'+ (row.equity||'') +'</td><td>'+ (row.resultado||'') +'</td><td>'+ (row.notas||'') +'</td>';
      if((row.resultado||'').toLowerCase()==='ganado') tr.classList.add('ganado');
      if((row.resultado||'').toLowerCase()==='perdido') tr.classList.add('perdido');
    }
    const tdDel=document.createElement('td'); const b=document.createElement('button'); b.textContent='üóëÔ∏è'; b.className='btn btn-danger';
    b.onclick=function(){ const arr=loadData(key); arr.splice(i,1); saveData(key,arr); updateAll(); };
    tdDel.appendChild(b); tr.appendChild(tdDel);
    tbody.appendChild(tr);
  });
}

function aggregateWeeks(){
  const tr=loadData('torneos'); const by={};
  tr.forEach(function(r){
    const d=parseDate(r.fecha); if(!d) return; const k=weekKey(d);
    const inv=(+r.buyin||0)+(+r.fee||0);
    const premios=(+r.premio||0);
    const neto=premios-inv; const manos=(+r.manos||0);
    if(!by[k]) by[k]={inv:0,premios:0,neto:0,manos:0};
    by[k].inv+=inv; by[k].premios+=premios; by[k].neto+=neto; by[k].manos+=manos;
  });
  const out=[]; for(const k in by) out.push(Object.assign({key:k}, by[k]));
  out.sort(function(a,b){return a.key<b.key? -1: 1;}); return out;
}

function renderWeekTable(){
  const weeks=aggregateWeeks();
  const tbody=document.querySelector('#wk_table tbody'); tbody.innerHTML='';
  weeks.forEach(function(w){
    const roi = w.inv>0 ? ((w.neto/w.inv)*100).toFixed(1)+'%' : '0%';
    const tr=document.createElement('tr');
    tr.innerHTML='<td>'+w.key+'</td><td>'+w.inv.toFixed(2)+'</td><td>'+w.premios.toFixed(2)+'</td><td>'+w.neto.toFixed(2)+'</td><td>'+roi+'</td><td>'+w.manos+'</td>';
    if(w.neto>=0) tr.classList.add('ganado'); else tr.classList.add('perdido');
    tbody.appendChild(tr);
  });
}

function updateCharts(){
  const bb=loadData('badbits'); const fp=loadData('flips'); const trd=loadData('torneos');

  const g1=bb.filter(r=>(r.resultado||'').toLowerCase()==='ganado').length;
  const p1=bb.filter(r=>(r.resultado||'').toLowerCase()==='perdido').length;
  if(bbChart) bbChart.destroy();
  bbChart=new Chart(document.getElementById('bb_chart'),{type:'pie',data:{labels:['Ganados','Perdidos'],datasets:[{data:[g1,p1],backgroundColor:['#10b981','#ef4444']}]}});

  const g2=fp.filter(r=>(r.resultado||'').toLowerCase()==='ganado').length;
  const p2=fp.filter(r=>(r.resultado||'').toLowerCase()==='perdido').length;
  if(fpChart) fpChart.destroy();
  fpChart=new Chart(document.getElementById('fp_chart'),{type:'pie',data:{labels:['Ganados','Perdidos'],datasets:[{data:[g2,p2],backgroundColor:['#10b981','#ef4444']}]}});

  const labels = trd.map(function(_,i){return 'Torneo '+(i+1);});
  const datos = trd.map(function(r){return (+r.premio||0)-((+r.buyin||0)+(+r.fee||0));});
  if(trChart) trChart.destroy();
  trChart=new Chart(document.getElementById('tr_chart'),{type:'bar',data:{labels:labels, datasets:[{label:'Neto', data:datos, backgroundColor:datos.map(function(v){return v>=0?'#10b981':'#ef4444';})}]}});

  const sLabels=labels; var acum=0;
  const series = trd.map(function(r){acum += (+r.premio||0)-((+r.buyin||0)+(+r.fee||0)); return acum;});
  if(summaryChart) summaryChart.destroy();
  summaryChart=new Chart(document.getElementById('summary_chart'),{type:'line',data:{labels:sLabels, datasets:[{label:'Ganancia Acumulada', data:series, borderColor:'#1d4ed8', backgroundColor:'#93c5fd', fill:true}]}, options:{scales:{y:{beginAtZero:true}}}});

  const cats=['BadBits','Flips','Torneos'];
  const wins=[g1,g2,trd.filter(r=>(r.resultado||'').toLowerCase()==='ganado').length];
  const losses=[p1,p2,trd.filter(r=>(r.resultado||'').toLowerCase()==='perdido').length];
  if(distChart) distChart.destroy();
  distChart=new Chart(document.getElementById('dist_chart'),{type:'bar',data:{labels:cats,datasets:[
    {label:'Ganados', data:wins, backgroundColor:'#10b981'},
    {label:'Perdidos', data:losses, backgroundColor:'#ef4444'}
  ]}});

  const weeks = aggregateWeeks();
  const wLabels = weeks.map(function(w){return w.key;});
  const wNeto = weeks.map(function(w){return w.neto;});
  const wROI  = weeks.map(function(w){return w.inv>0 ? +((w.neto/w.inv)*100).toFixed(1) : 0;});
  const wManos= weeks.map(function(w){return w.manos||0;});

  if(wkChart) wkChart.destroy();
  wkChart=new Chart(document.getElementById('wk_chart'),{type:'bar',data:{labels:wLabels,datasets:[{label:'Neto semanal',data:wNeto,backgroundColor:wNeto.map(function(v){return v>=0?'#10b981':'#ef4444';})}]}});

  if(roiChart) roiChart.destroy();
  roiChart=new Chart(document.getElementById('roi_chart'),{type:'line',data:{labels:wLabels,datasets:[{label:'ROI % semanal',data:wROI,borderColor:'#1d4ed8',backgroundColor:wROI.map(function(v){return v>=0?'#10b981':'#ef4444';}),fill:false}]}});

  if(manosChart) manosChart.destroy();
  manosChart=new Chart(document.getElementById('manos_chart'),{type:'bar',data:{labels:wLabels,datasets:[{label:'Manos semanales',data:wManos,backgroundColor:'#3b82f6'}]}});
}

// ========= Forms & buttons =========
document.getElementById('bb_calc').onclick = function(){ const f=document.getElementById('bb_form'); calcEquity('bb_equity', f.mi_mano.value, f.mano_rival.value); };
document.getElementById('fp_calc').onclick = function(){ const f=document.getElementById('fp_form'); calcEquity('fp_equity', f.mi_mano.value, f.mano_rival.value); };

document.getElementById('bb_form').onsubmit = function(e){ e.preventDefault(); const row=Object.fromEntries(new FormData(e.target).entries()); const arr=loadData('badbits'); arr.push(row); saveData('badbits',arr); sendToSheets(Object.assign({tipo:'BadBit'}, row)); e.target.reset(); updateAll(); };
document.getElementById('fp_form').onsubmit = function(e){ e.preventDefault(); const row=Object.fromEntries(new FormData(e.target).entries()); const arr=loadData('flips'); arr.push(row); saveData('flips',arr); sendToSheets(Object.assign({tipo:'Flip'}, row)); e.target.reset(); updateAll(); };
document.getElementById('tr_form').onsubmit = function(e){ e.preventDefault(); const row=Object.fromEntries(new FormData(e.target).entries()); const arr=loadData('torneos'); arr.push(row); saveData('torneos',arr); sendToSheets(Object.assign({tipo:'Torneo'}, row)); e.target.reset(); updateAll(); };

// ========= Update All =========
function updateAll(){
  renderTable('badbits','#bb_table');
  renderTable('flips','#fp_table');
  renderTable('torneos','#tr_table');
  renderWeekTable();
  const trd=loadData('torneos');
  const inv = trd.reduce(function(s,r){return s + (+r.buyin||0)+(+r.fee||0);}, 0);
  const premios = trd.reduce(function(s,r){return s + (+r.premio||0);}, 0);
  const neto = premios - inv;
  const roi = inv>0 ? (neto/inv*100).toFixed(1)+'%' : '0%';
  document.getElementById('summary').innerHTML = '<p><b>Invertido:</b> $'+inv.toFixed(2)+' ¬∑ <b>Premios:</b> $'+premios.toFixed(2)+' ¬∑ <b>Neto:</b> $'+neto.toFixed(2)+' ¬∑ <b>ROI:</b> '+roi+'</p>';
  updateCharts();
}
updateAll();

// ====== Torneos: Render personalizado con Edit & Delete (con confirm) ======
function renderTableTorneos(){
  const data = loadData('torneos');
  const tbody = document.querySelector('#tr_table tbody');
  if(!tbody) return;
  tbody.innerHTML = '';
  data.forEach((row,i)=>{
    const tr = document.createElement('tr');
    const inv=(+row.buyin||0)+(+row.fee||0);
    const neto=(+row.premio||0)-inv;
    const roi = inv>0 ? ((neto/inv)*100).toFixed(1)+'%' : '0%';
    tr.innerHTML = '<td>'+(row.fecha||'')+'</td><td>'+(row.sala||'')+'</td><td>'+(row.nombre||'')+'</td>'
      + '<td>'+(row.buyin||'')+'</td><td>'+(row.fee||'')+'</td><td>'+(row.premio||'')+'</td><td>'+(row.entradas||'')+'</td><td>'+(row.pos||'')+'</td>'
      + '<td>'+inv.toFixed(2)+'</td><td>'+neto.toFixed(2)+'</td><td>'+roi+'</td>'
      + '<td>'+(row.resultado||'')+'</td><td>'+(row.notas||'')+'</td>';
    if(neto>=0) tr.classList.add('ganado'); else tr.classList.add('perdido');

    // Edit button
    const tdE = document.createElement('td');
    const bE = document.createElement('button');
    bE.textContent = '‚úèÔ∏è'; bE.className = 'btn btn-neutral';
    bE.onclick = function(){
      const f = document.getElementById('tr_form');
      if(!f) return;
      for(const [k,v] of Object.entries(row)){ if(f[k]!==undefined) f[k].value = v; }
      f.dataset.editIndex = i; // mark editing index
      // Cambia de pesta√±a a "torneos" si est√°s en otra
      document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
      document.querySelector('.tab[data-tab="torneos"]').classList.add('active');
      document.getElementById('torneos').classList.add('active');
      window.scrollTo({top:0, behavior:'smooth'});
    };
    tdE.appendChild(bE);
    tr.appendChild(tdE);

    // Delete button with confirm + move to trash
    const tdD = document.createElement('td');
    const bD = document.createElement('button');
    bD.textContent = 'üóëÔ∏è'; bD.className = 'btn btn-danger';
    bD.onclick = function(){
      if(!confirm('¬øSeguro que quieres borrar este torneo?')) return;
      const arr = loadData('torneos');
      const removed = arr.splice(i,1)[0];
      saveData('torneos', arr);
      const trash = loadData('torneos_eliminados'); trash.push(removed); saveData('torneos_eliminados', trash);
      updateAll();
    };
    tdD.appendChild(bD);
    tr.appendChild(tdD);

    tbody.appendChild(tr);
  });
}

// Hook: override only the torneos render call, keep the rest intact
(function(){
  // Monkey-patch updateAll to replace generic torneos render by our custom one
  const _ua = updateAll;
  window.updateAll = function(){
    // call original
    _ua();
    try {
      // Immediately after original renders, overwrite torneos table with custom actions
      if(document.getElementById('tr_table')) renderTableTorneos();
      renderTrash();
    } catch(e){ console.warn('patch updateAll error', e); }
  };
})();

// ====== Papelera (Trash) in Config ======
function renderTrash(){
  const arr = loadData('torneos_eliminados');
  const tbody = document.querySelector('#trash_table tbody');
  if(!tbody) return;
  tbody.innerHTML = '';
  arr.forEach((row,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = '<td>'+(row.fecha||'')+'</td><td>'+(row.sala||'')+'</td><td>'+(row.nombre||'')+'</td>';
    const td = document.createElement('td');
    const btn = document.createElement('button');
    btn.textContent = '‚ôªÔ∏è Restaurar'; btn.className = 'btn btn-primary';
    btn.onclick = function(){
      const trash = loadData('torneos_eliminados');
      const rec = trash.splice(i,1)[0];
      saveData('torneos_eliminados', trash);
      const arr = loadData('torneos'); arr.push(rec); saveData('torneos', arr);
      updateAll();
    };
    td.appendChild(btn);
    tr.appendChild(td);
    tbody.appendChild(tr);
  });
}

// ====== Submit en Torneos con modo edici√≥n ======
(function(){
  const form = document.getElementById('tr_form');
  if(!form) return;
  const originalSubmit = form.onsubmit;
  form.onsubmit = function(e){
    e.preventDefault();
    const row = Object.fromEntries(new FormData(form).entries());
    let arr = loadData('torneos');
    if(form.dataset.editIndex !== undefined){
      const idx = +form.dataset.editIndex;
      arr[idx] = row;
      delete form.dataset.editIndex;
    } else {
      arr.push(row);
    }
    saveData('torneos', arr);
    sendToSheets(Object.assign({tipo:'Torneo'}, row));
    form.reset();
    updateAll();
  };
})();

// Render trash on load once
document.addEventListener('DOMContentLoaded', renderTrash);

</script>
</body>
</html>
